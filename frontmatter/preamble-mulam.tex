% !TeX program = XeLaTeX
% !TeX root = ../ramayana-ratnakara-mulam.tex
\usepackage{shloka}
\usepackage{wallpaper}
\usepackage{charter,fbb}

\setmainfont[Script=Devanagari]{Sanskrit 2003}
\setromanfont{fbb}
\setsansfont{fbb}

%%% HEADERS and FOOTERS %%%
\usepackage{fancyhdr}
\pagestyle{fancyplain}
\setlength{\headheight}{28pt}
\lhead[\fancyplain{\rightmark}{\pagenumfont\large\thepage}]
   {\fancyplain{\rightmark}{\leftmark}}
\rhead[\fancyplain{\rightmark}{\leftmark}]
   {\fancyplain{\rightmark}{\pagenumfont\large\thepage}}
\cfoot{}

\fancypagestyle{fancyplain}{ %
\fancyhf{} % remove everything
\renewcommand{\headrulewidth}{0pt} % remove lines as well
\renewcommand{\footrulewidth}{0pt}
\cfoot{\pagenumfont\large\thepage}}

%%% SECTIONS and CHAPTERS %%%
\makeatletter
\renewcommand\section{\resetShloka\@startsection {section}{1}{\z@}%
%{2.3ex \@plus.2ex}%
%{-3.5ex \@plus -1ex \@minus -.2ex}%
%{2.3ex \@plus.2ex}%
{10pt}
{2pt}
{\normalfont\LARGE\bfseries}}

\renewcommand\chapter{\resetShloka\@startsection {chapter}{1}{\z@}%
{10pt}
{2pt}
{\normalfont\LARGE\bfseries}}
\makeatother

\setcounter{secnumdepth}{-1}
%for weird reasons this does not bookmark the section start, but the start of text in the section!!!
%\renewcommand\thesection{}
\renewcommand{\sectionmark}[1]{%
\markboth{\large #1}{\rightmark}
}
\renewcommand{\subsectionmark}[1]{%
\markboth{\large #1}{\rightmark}
}
\renewcommand{\chaptermark}[1]{%
\markboth{\large #1}{\rightmark}
}

\addtolength{\parskip}{4pt}
%\addtolength{\headsep}{10pt}
\setlength{\columnseprule}{1pt}
\setlength{\columnsep}{30pt}

%%% HYPERLINKS %%%
\usepackage[bookmarks=true,bookmarksopen=true,xetex,colorlinks=true,
linkcolor=black,					% colour of internal links
citecolor=cyan,					% colour of links to bibliography
filecolor=magenta,			% colour of file links
urlcolor=black					% colour of external links
]{hyperref}

%%% MISCELLANEOUS %%%
\hbadness=10000
\vbadness=10000
\hfuzz=6pt
%\listfiles

%% MACROS
\usepackage{fontawesome5} % Requires xelatex or lualatex
\usepackage{tcolorbox}
\tcbuselibrary{breakable, skins}

\newcommand{\src}[4]{%
  \def\sourceText{#1}%
  \def\sourceKanda{#2}%
  \def\sourceChapter{#3}%
  \def\sourceVerses{#4}%
  \def\fullSource{\sourceText}%
  %
  \if\relax\detokenize{#2}\relax
    % empty Kanda → do nothing
  \else
    \edef\fullSource{\fullSource / \sourceKanda}%
  \fi
  %
  \if\relax\detokenize{#3}\relax
    % empty Chapter → do nothing
  \else
    \edef\fullSource{\fullSource / \sourceChapter}%
  \fi
  %
  \if\relax\detokenize{#4}\relax
    % empty Verses → do nothing
  \else
    \edef\fullSource{\fullSource / \sourceVerses}%
  \fi
}


\newcommand{\vakta}[1]{\def\vaktaName{#1}}
\newcommand{\shrota}[1]{\def\shrotaName{#1}}
\newcommand{\tags}[1]{\def\tagList{#1}}
\newcommand{\notes}[1]{\def\storyNotes{#1}}
\newcommand{\textlink}[1]{\def\textURL{#1}}
\newcommand{\translink}[1]{\def\transURL{#1}}


\newtcolorbox{StoryMetadataBox}{
  enhanced,
  drop small lifted shadow=red,
  breakable,
  colback=gray!5,
  colframe=gray!5,
  fonttitle=\bfseries,
  % title=\faBookOpen\quad Story Metadata,
  % coltitle=black,
  % sharp corners,
  % boxrule=0.5pt,
  left=1em, right=1em, top=0.5em, bottom=0.5em,
}

\def\extractdomain#1://#2/#3\enddomain{#2}

\def\domainfromurl#1{%
  \expandafter\extractdomain#1/\enddomain
}

\newcommand{\storymeta}{
\begin{StoryMetadataBox}
  \small
\begin{description}
  \item[\faBook]\textbf{\fullSource}
  \ifx\vaktaName\empty \else \item[\faUser\ ~वक्ता ---] \vaktaName\fi
\hspace{2em}\ifx\shrotaName\empty \else \faUserFriends\ \textbf{श्रोता} --- \shrotaName\fi
  % \item[\faCommentDots\ \sffamily\small\footnotesize~Notes:] \textsf{\footnotesize\storyNotes}
  \item[\faCommentDots\sffamily\small\footnotesize]\textsf{\footnotesize\storyNotes}
  % \item[\faTags]\hspace{-0.4ex}\tagList
  \ifx\textURL\empty \else\item[\faLink] \href{\textURL}{Source Text: \domainfromurl{\textURL}} \fi
  \ifx\transURL\empty \else\item[\faGlobe] \href{\transURL}{Translation: \domainfromurl{\transURL}} \fi
\end{description}
\end{StoryMetadataBox}
}

\def\sourceText{}
\def\sourceKanda{}
\def\sourceChapter{}
\def\sourceVerses{}
\def\fullSource{}
\def\vaktaName{}
\def\shrotaName{}
\def\tagList{}
\def\storyNotes{}
\def\textURL{}
\def\transURL{}
